<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!-- Use title if it's in the page YAML frontmatter -->
    <title>
      Greg Burek - 
      Installing bcc to evaluate BPF and Postgres
      
    </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="x-B-7Gh5W7YevI09T48-S4on8MkU9MjG-6XD7aurE7Y" />
    <meta name="google-site-verification" content="hzWlqDEbM4CUsiEb8YrcUdovSZSNx6jySbQkjRXyCCk" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <link href="/stylesheets/all.css" rel="stylesheet" />
    <script type="text/javascript" src="//use.typekit.net/rtf4ikk.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <script src="/js/vendor/modernizr-2.6.1.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
             })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-22983311-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body class="x2016 x2016_10 x2016_10_04 x2016_10_04_installing-bcc-to-evaluate-bpf-and-postgres x2016_10_04_installing-bcc-to-evaluate-bpf-and-postgres_index">
    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
    <![endif]-->

    <header>
  <div class="container">
    <h1>
      <a href="../../../../">Greg Burek</a>
    </h1>
  </div>
</header>


    <div class="container">
        <article class="writing">
    <h1>Installing bcc to evaluate BPF and Postgres</h1>
    <div class="article-details">
      <div class="article-date">
        <i class="fa fa-paper-plane-o"></i>
        October 04, 2016
        <div class="tags">
          tags:
            <a href="/tags/bpf/">bpf</a>,
            <a href="/tags/discovery/">discovery</a>,
            <a href="/tags/linux/">linux</a>,
            <a href="/tags/performance/">performance</a>,
            <a href="/tags/postgres/">postgres</a>,
            <a href="/tags/ubuntu/">ubuntu</a>
        </div>
      </div>
    </div>
    <p><a href="https://twitter.com/t_crayford">@t_crayford</a> sent me Brendan Gregg&rsquo;s latest
missive about performance tracing, this time for <a href="http://www.brendangregg.com/blog/2016-10-04/linux-bcc-mysqld-qslower.html">Linux MySQL Slow Query Tracing with bcc/BPF</a>.</p>

<p></p>

<p><a href="https://github.com/iovisor/bcc">bcc</a> stands for &lsquo;BPF Compiler Collection&rsquo; and
<a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter">BPF</a> stands for
&#39;Berkeley Packet Filter&rsquo;. From the bcc
<a href="https://github.com/iovisor/bcc/blob/60393ea5dd966d33ff24929f6981df09473cbb1b/README.md">README</a>:</p>

<blockquote>
<p>BCC is a toolkit for creating efficient kernel tracing and manipulation
programs, and includes several useful tools and examples. It makes use of
extended BPF (Berkeley Packet Filters), formally known as eBPF, a new feature
that was first added to Linux 3.15. Much of what BCC uses requires Linux 4.1
and above.</p>

<p>eBPF was <a href="https://lkml.org/lkml/2015/4/14/232">described</a> by Ingo Moln√°r as:</p>

<blockquote>
<p>One of the more interesting features in this cycle is the ability to attach
eBPF programs (user-defined, sandboxed bytecode executed by the kernel) to
kprobes. This allows user-defined instrumentation on a live kernel image
that can never crash, hang or interfere with the kernel negatively.</p>
</blockquote>

<p>BCC makes BPF programs easier to write, with kernel instrumentation in C (and
includes a C wrapper around LLVM), and front-ends in Python and lua. It is
suited for many tasks, including performance analysis and network traffic
control.</p>
</blockquote>

<p>As I work for Heroku Postgres, I wanted to investigate something similar for
Postgres, running on our infrastructure. First thing to check was if it was
even possible on our systems, using <a href="https://github.com/iovisor/bcc/blob/60393ea5dd966d33ff24929f6981df09473cbb1b/INSTALL.md">bcc&rsquo;s INSTALL
instructions</a>.</p>

<p>New Postgres databases get Ubuntu Trusty instances with
<code>linux-generic-lts-xenial</code> kernels of the 4.4 series:</p>
<pre class="highlight plaintext"><code>=&gt; select version();
                                             version
-------------------------------------------------------------------------------------------------
 PostgreSQL 9.5.4 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 4.8.2-19ubuntu1) 4.8.2, 64-bit
(1 row)
</code></pre><pre class="highlight plaintext"><code>~$ uname -a
Linux ip-10-0-10-230 4.4.0-38-generic #57~14.04.1-Ubuntu SMP Tue Sep 6 17:20:43 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>This seems to satisfy the <code>Linux kernel version 4.1 or newer</code> requirement.</p>

<p>Next thing to check is if the kernel has been compiled properly:</p>
<pre class="highlight plaintext"><code>~$ cat /boot/config-4.4.0-38-generic | grep BPF
CONFIG_BPF=y
CONFIG_BPF_SYSCALL=y
CONFIG_NETFILTER_XT_MATCH_BPF=m
CONFIG_NET_CLS_BPF=m
CONFIG_NET_ACT_BPF=m
CONFIG_BPF_JIT=y
CONFIG_HAVE_BPF_JIT=y
CONFIG_BPF_EVENTS=y
CONFIG_TEST_BPF=m
</code></pre>
<p>This looks ok! Next up is to install the repo and tools:</p>
<pre class="highlight plaintext"><code>~$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys D4284CDD
...
gpg: requesting key D4284CDD from hkp server keyserver.ubuntu.com
gpg: key D4284CDD: public key "Brenden Blanco &lt;bblanco@plumgrid.com&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
~$ echo "deb https://repo.iovisor.org/apt trusty main" | sudo tee /etc/apt/sources.list.d/iovisor.list
deb https://repo.iovisor.org/apt trusty main
~$ sudo apt-get update
...
Fetched 4,322 kB in 3s (1,269 kB/s)
Reading package lists... Done
~$ sudo apt-get install binutils bcc bcc-tools libbcc-examples python-bcc
Reading package lists... Done
Building dependency tree
Reading state information... Done
binutils is already the newest version.
binutils set to manually installed.
The following extra packages will be installed:
  bin86 elks-libc libbcc
The following NEW packages will be installed:
  bcc bcc-tools bin86 elks-libc libbcc libbcc-examples python-bcc
0 upgraded, 7 newly installed, 0 to remove and 30 not upgraded.
Need to get 10.4 MB of archives.
After this operation, 36.6 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
...
~$
</code></pre>
<p>Now to test this out:</p>
<pre class="highlight plaintext"><code># /usr/share/bcc/tools/tplist -l /usr/lib/postgresql/9.5/bin/postgres
Traceback (most recent call last):
  File "/usr/share/bcc/tools/tplist", line 16, in &lt;module&gt;
    from bcc import USDTReader
ImportError: cannot import name USDTReader
</code></pre>
<p>Welp. Looking at the source of <a href="https://github.com/iovisor/bcc/blob/6e60fbc8a672d8f29cab688ddc0df6d43a96c300/tools/tplist.py">tplist on current master</a>,
the <a href="https://github.com/iovisor/bcc/commit/69e361ac66fbf3baadb1f7cf21762df61ad7a5a9#diff-8189c35f15538919a795b3f18ad0db66L16">most recent commit</a>
removes <code>USDTReader</code>. Time to try the nightly builds:</p>
<pre class="highlight plaintext"><code>~$ echo "deb [trusted=yes] https://repo.iovisor.org/apt/trusty trusty-nightly main" | sudo tee /etc/apt/sources.list.d/iovisor.list
~$ sudo apt-get update
~$ sudo apt-get install bcc-tools
~$ sudo /usr/share/bcc/tools/tplist -l /usr/lib/postgresql/9.5/bin/postgres
'USDT' object has no attribute 'enumerate_probes'
</code></pre>
<p>Welp. <code>enumerate_probes</code> was added in another part of the <a href="https://github.com/iovisor/bcc/commit/69e361ac66fbf3baadb1f7cf21762df61ad7a5a9#diff-4cf0bde404ce4b67b2961b61419fa23fR58">above patch</a>, so I think other things
need to be updated, as well.</p>
<pre class="highlight plaintext"><code>~$ sudo apt-get install binutils bcc bcc-tools libbcc-examples python-bcc
Reading package lists... Done
Building dependency tree
Reading state information... Done
bcc is already the newest version.
binutils is already the newest version.
bcc-tools is already the newest version.
The following packages will be upgraded:
  libbcc-examples python-bcc
2 upgraded, 0 newly installed, 0 to remove and 31 not upgraded.
Need to get 302 kB of archives.
After this operation, 6,144 B of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 https://repo.iovisor.org/apt/trusty/ trusty-nightly/main libbcc-examples amd64 0.2.0-22.git.12a09dc [267 kB]
Get:2 https://repo.iovisor.org/apt/trusty/ trusty-nightly/main python-bcc all 0.2.0-22.git.12a09dc [34.3 kB]
Fetched 302 kB in 0s (319 kB/s)
(Reading database ... 91427 files and directories currently installed.)
Preparing to unpack .../libbcc-examples_0.2.0-22.git.12a09dc_amd64.deb ...
Unpacking libbcc-examples (0.2.0-22.git.12a09dc) over (0.2.0-1) ...
Preparing to unpack .../python-bcc_0.2.0-22.git.12a09dc_all.deb ...
Unpacking python-bcc (0.2.0-22.git.12a09dc) over (0.2.0-1) ...
Setting up libbcc-examples (0.2.0-22.git.12a09dc) ...
Setting up python-bcc (0.2.0-22.git.12a09dc) ...
~$ less /usr/lib/python2.7/dist-packages/bcc/usdt.py
~$ sudo /usr/share/bcc/tools/tplist -l /usr/lib/postgresql/9.5/bin/postgres
Traceback (most recent call last):
  File "/usr/share/bcc/tools/tplist", line 16, in &lt;module&gt;
    from bcc import USDT
  File "/usr/lib/python2.7/dist-packages/bcc/__init__.py", line 28, in &lt;module&gt;
    from .libbcc import lib, _CB_TYPE, bcc_symbol
  File "/usr/lib/python2.7/dist-packages/bcc/libbcc.py", line 160, in &lt;module&gt;
    lib.bcc_usdt_get_probe_argctype.restype = ct.c_char_p
  File "/usr/lib/python2.7/ctypes/__init__.py", line 378, in __getattr__
    func = self.__getitem__(name)
  File "/usr/lib/python2.7/ctypes/__init__.py", line 383, in __getitem__
    func = self._FuncPtr((name_or_ordinal, self))
AttributeError: /usr/lib/x86_64-linux-gnu/libbcc.so.0: undefined symbol: bcc_usdt_get_probe_argctype
</code></pre>
<p>One more error. This time in <code>libbcc</code>. Seems like another package to pull from nightly.</p>
<pre class="highlight plaintext"><code>~$ sudo apt-get install libbcc
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages will be upgraded:
  libbcc
1 upgraded, 0 newly installed, 0 to remove and 30 not upgraded.
Need to get 9,505 kB of archives.
After this operation, 0 B of additional disk space will be used.
Get:1 https://repo.iovisor.org/apt/trusty/ trusty-nightly/main libbcc amd64 0.2.0-22.git.12a09dc [9,505 kB]
Fetched 9,505 kB in 2s (3,276 kB/s)
(Reading database ... 91427 files and directories currently installed.)
Preparing to unpack .../libbcc_0.2.0-22.git.12a09dc_amd64.deb ...
Unpacking libbcc (0.2.0-22.git.12a09dc) over (0.2.0-1) ...
Setting up libbcc (0.2.0-22.git.12a09dc) ...
Processing triggers for libc-bin (2.19-0ubuntu6.9) ...
~$ sudo /usr/share/bcc/tools/tplist -l /usr/lib/postgresql/9.5/bin/postgres
~$
</code></pre>
<p>OK! No errors. This is good, as it answers my questions as to if this postgres
package was compiled with the <code>--enable-dtrace</code>. I can further confirm with
<code>readelf -n</code></p>
<pre class="highlight plaintext"><code>~$ readelf -n /usr/lib/postgresql/9.5/bin/postgres

Displaying notes found at file offset 0x00000254 with length 0x00000020:
  Owner                 Data size       Description
  GNU                  0x00000010       NT_GNU_ABI_TAG (ABI version tag)
    OS: Linux, ABI: 2.6.24

Displaying notes found at file offset 0x00000274 with length 0x00000024:
  Owner                 Data size       Description
  GNU                  0x00000014       NT_GNU_BUILD_ID (unique build ID bitstring)
    Build ID: 6990037682e6668adc87ae7a6b82e4640959cf52
</code></pre>
<p>There are no USDT or bpf traces found here, so next step is to recompile
postgres with <code>--enable-dtrace</code> and see what probes are available to use with
BPF (spoiler: <a href="https://www.postgresql.org/docs/current/static/dynamic-trace.html">there are a lot of them</a>).</p>

  </article>

    </div>

    <footer>
  <div class="container">
    <ul class="social-nav">
      <li>
        <a href="https://twitter.com/gregburek">
          <i class="fa fa-twitter-square"></i>
        </a>
      </li>
       <li>
        <a href="https://github.com/gregburek">
          <i class="fa fa fa-github-square"></i>
        </a>
      </li>
      <li>
        <a href="http://lanyrd.com/profile/gregburek/">
          <i class="fa fa fa-map-marker"></i>
        </a>
      </li>
      <li>
        <a href="http://www.linkedin.com/in/gregburek">
          <i class="fa fa fa-linkedin-square"></i>
        </a>
      </li>
      <li>
      <a href="http://www.flickr.com/photos/gregburek/">
          <i class="fa fa fa-flickr"></i>
        </a>
      </li>
     <li>
        <a href="../../../../feed.xml"><i class="fa fa-rss-square"></i></a>
      </li>
    </ul>
    <nav>
      <ul>
        <li>
        <a href="../../../../about/">About</a>
        </li>
        <li>
        <a href="/tags/">Tags</a>
        </li>
      </ul>
    </nav>
  </div>
</footer>

    <script src="/js/plugins.js"></script>
    <script src="/js/ga.js"></script>
  </body>
</html>
