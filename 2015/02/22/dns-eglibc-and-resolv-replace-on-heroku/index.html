<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!-- Use title if it's in the page YAML frontmatter -->
    <title>
      Greg Burek - 
      DNS, eglibc and resolv-replace on Heroku
      
    </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="x-B-7Gh5W7YevI09T48-S4on8MkU9MjG-6XD7aurE7Y" />
    <meta name="google-site-verification" content="hzWlqDEbM4CUsiEb8YrcUdovSZSNx6jySbQkjRXyCCk" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <link href="/css/normalize.css" rel="stylesheet" type="text/css" />
    <link href="/css/main.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="//use.typekit.net/rtf4ikk.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <script src="/js/vendor/modernizr-2.6.1.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
             })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-22983311-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body class="x2015 x2015_02 x2015_02_22 x2015_02_22_dns-eglibc-and-resolv-replace-on-heroku x2015_02_22_dns-eglibc-and-resolv-replace-on-heroku_index">
    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
    <![endif]-->

    <header>
  <div class="container">
    <h1>
      <a href="../../../../">Greg Burek</a>
    </h1>
  </div>
</header>


    <div class="container">
        <article class="writing">
    <h1>DNS, eglibc and resolv-replace on Heroku</h1>
    <div class="article-details">
      <div class="article-date">
        <i class="fa fa-paper-plane-o"></i>
        February 22, 2015
        <div class="tags">
          tags:
            <a href="/tags/dns/">dns</a>,
            <a href="/tags/heroku/">heroku</a>,
            <a href="/tags/libc/">libc</a>,
            <a href="/tags/ruby/">ruby</a>,
            <a href="/tags/yaks/">yaks</a>
        </div>
      </div>
    </div>
    <p>2015-03-01: Fixed versions of eglibc are available for Ubuntu Precise and
Trusty. Time to update.</p>

<p>I work on the team that runs <a href="https://www.heroku.com/postgres">Heroku Postgres</a>. As we have continued to grow, I
have been tracking an intermitent error with <a href="https://devcenter.heroku.com/articles/rollbar">Rollbar</a> that occurs about once
every 50,000 HTTP requests. As we are doing many hundreds of thousands of API
calls a minute to various services, this error can pop up fairly frequently and
in very inconvenient places. The most common traceback seems to indicate a
failure to resolve DNS:</p>
<pre class="highlight ruby"><code><span class="c1">#&lt;SocketError: getaddrinfo: Name or service not known&gt;</span>
<span class="sr">/app/</span><span class="n">vendor</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">879</span><span class="ss">:in</span> <span class="s1">'initialize'</span>
<span class="sr">/app/</span><span class="n">vendor</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">879</span><span class="ss">:in</span> <span class="s1">'open'</span>
<span class="sr">/app/</span><span class="n">vendor</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">879</span><span class="ss">:in</span> <span class="s1">'block in connect'</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre>

<p><a href="http://lmgtfy.com/?q=SocketError%3A+getaddrinfo%3A+Name+or+service+not+known+heroku">Google</a> led me to a <a href="http://www.subelsky.com/2014/05/fixing-socketerror-getaddrinfo-name-or.html">pertinent blog post</a> that recommended using ruby&rsquo;s
<a href="http://apidock.com/ruby/Resolv">Resolv</a> library for all DNS requests via a script called <a href="https://github.com/ruby/ruby/blob/trunk/lib/resolv-replace.rb">resolv-replace</a>.
Adding a single line to our initializers, <code>require resolv-replace</code>, caused errors
while submitting Logplex messages to immediately drop:</p>

<p><img alt="Logplex Errors" src="/2015/02/22/dns-eglibc-and-resolv-replace-on-heroku/logplex_errors.png" /></p>

<p>As did errors from trying to interact with our monitoring service, Observatory:</p>

<p><img alt="Observatory Errors" src="/2015/02/22/dns-eglibc-and-resolv-replace-on-heroku/observatory_errors.png" /></p>

<p>In an internal thread, <a href="https://twitter.com/freeformz">Ed Muller</a> pointed out a <a href="https://github.com/golang/go/issues/6336#issuecomment-66085142">golang work around</a>
of a <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=15946">bug in glibc</a> which is very likely to be a factor in this error:</p>

<blockquote>
<p>Under high load, getaddrinfo() starts sending DNS queries to random
file descriptors, e.g. some unrelated socket connected to a remote service.</p>
</blockquote>

<p>As Heroku is a shared platform with multitenant runtime instances, it is
possible for a random runtime to experience high load and the <a href="https://devcenter.heroku.com/articles/cedar-ubuntu-packages">cedar-14 glibc
binaries</a> are known to be impacted by this bug. Version 2.20 of glibc has a
fix and as of <a href="https://bazaar.launchpad.net/~ubuntu-branches/ubuntu/trusty/eglibc/trusty-security/revision/346">2.19-0ubuntu6.6</a> and <a href="https://bazaar.launchpad.net/~ubuntu-branches/ubuntu/precise/eglibc/precise-security/revision/316">2.15-0ubuntu10.11</a> this fix was
backported to Ubuntu Precise and Trusty. <s>However, Ubuntu Precise currently
ships <a href="http://packages.ubuntu.com/precise-updates/libc6">2.15-0ubuntu10.10</a> and Trusty provides <a href="http://packages.ubuntu.com/trusty-updates/libc6">2.19-0ubuntu6.5</a>, so this
bug may continue to be a problem for some time to come.</s></p>

<p>My immediate recommendation is to use language native DNS resolution like
<code>resolv-replace</code> whenever possible, on Heroku or other systems. However, if you
require ipv6 or run into problems with <a href="https://github.com/mperham/sidekiq/issues/1258#issuecomment-27389456">third party gems attempting to resolve
<code>nil</code> addresses</a>, and are stuck with the system DNS, upgrade yourself!
<s>please indicate that this bug affects you on the <a href="https://bugs.launchpad.net/eglibc/+bug/1421393">Launchpad bug report
requesting backporting</a> to supported versions of Ubuntu.</s></p>

<p>Thanks to Ed Muller, Michael Hale, Keiko Oda, Steve Conklin, Terence Lee and
Richard Schneeman for help in figuring this out.</p>

  </article>

    </div>

    <footer>
  <div class="container">
    <ul class="social-nav">
      <li>
        <a href="https://twitter.com/gregburek">
          <i class="fa fa-twitter-square"></i>
        </a>
      </li>
       <li>
        <a href="https://github.com/gregburek">
          <i class="fa fa fa-github-square"></i>
        </a>
      </li>
      <li>
        <a href="http://lanyrd.com/profile/gregburek/">
          <i class="fa fa fa-map-marker"></i>
        </a>
      </li>
      <li>
        <a href="http://www.linkedin.com/in/gregburek">
          <i class="fa fa fa-linkedin-square"></i>
        </a>
      </li>
      <li>
      <a href="http://www.flickr.com/photos/gregburek/">
          <i class="fa fa fa-flickr"></i>
        </a>
      </li>
     <li>
        <a href="../../../../feed.xml"><i class="fa fa-rss-square"></i></a>
      </li>
    </ul>
    <nav>
      <ul>
        <li>
        <a href="../../../../about/">About</a>
        </li>
        <li>
        <a href="/tags/">Tags</a>
        </li>
      </ul>
    </nav>
  </div>
</footer>

    <script src="/js/plugins.js" type="text/javascript"></script>
    <script src="/js/ga.js" type="text/javascript"></script>
  </body>
</html>
